// <auto-generated />
// Built from: hl7.fhir.r4b.core version: 4.3.0-snapshot1
  // Option: "NAMESPACE" = "fhirCsR4B"

using System;
using System.Buffers;
using System.Collections.Generic;
using System.IO;
using System.Text;
using System.Text.Json;
using System.Text.Json.Serialization;
using fhirCsR4B.Models;

namespace fhirCsR4B.Serialization
{
  /// <summary>
  /// Common resource converter to support polymorphic deserialization.
  /// </summary>
  public class JsonStreamResourceConverter : JsonConverter<Resource>
  {
    private static readonly byte[] _startObject = Encoding.UTF8.GetBytes("{");
    private static readonly byte[] _endObject = Encoding.UTF8.GetBytes("}");
    private static readonly byte[] _startArray = Encoding.UTF8.GetBytes("[");
    private static readonly byte[] _endArray = Encoding.UTF8.GetBytes("]");
    private static readonly byte[] _comma = Encoding.UTF8.GetBytes(",");
    private static readonly byte[] _propertySep = Encoding.UTF8.GetBytes(":");
    private static readonly byte[] _quote = Encoding.UTF8.GetBytes("\"");

    /// <summary>
    /// Determines whether the specified type can be converted.
    /// </summary>
    public override bool CanConvert(Type objectType) =>
      typeof(Resource).IsAssignableFrom(objectType);

    /// <summary>
    /// Writes a specified value as JSON.
    /// </summary>
    public override void Write(Utf8JsonWriter writer, Resource resource, JsonSerializerOptions options)
    {
      switch (resource)
      {
        case fhirCsR4B.Models.Account typedAccount:
          typedAccount.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ActivityDefinition typedActivityDefinition:
          typedActivityDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.AdministrableProductDefinition typedAdministrableProductDefinition:
          typedAdministrableProductDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.AdverseEvent typedAdverseEvent:
          typedAdverseEvent.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.AllergyIntolerance typedAllergyIntolerance:
          typedAllergyIntolerance.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Appointment typedAppointment:
          typedAppointment.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.AppointmentResponse typedAppointmentResponse:
          typedAppointmentResponse.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.AuditEvent typedAuditEvent:
          typedAuditEvent.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Basic typedBasic:
          typedBasic.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Binary typedBinary:
          typedBinary.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.BiologicallyDerivedProduct typedBiologicallyDerivedProduct:
          typedBiologicallyDerivedProduct.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.BodyStructure typedBodyStructure:
          typedBodyStructure.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Bundle typedBundle:
          typedBundle.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.CapabilityStatement typedCapabilityStatement:
          typedCapabilityStatement.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.CarePlan typedCarePlan:
          typedCarePlan.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.CareTeam typedCareTeam:
          typedCareTeam.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.CatalogEntry typedCatalogEntry:
          typedCatalogEntry.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ChargeItem typedChargeItem:
          typedChargeItem.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ChargeItemDefinition typedChargeItemDefinition:
          typedChargeItemDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Citation typedCitation:
          typedCitation.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Claim typedClaim:
          typedClaim.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ClaimResponse typedClaimResponse:
          typedClaimResponse.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ClinicalImpression typedClinicalImpression:
          typedClinicalImpression.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ClinicalUseDefinition typedClinicalUseDefinition:
          typedClinicalUseDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.CodeSystem typedCodeSystem:
          typedCodeSystem.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Communication typedCommunication:
          typedCommunication.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.CommunicationRequest typedCommunicationRequest:
          typedCommunicationRequest.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.CompartmentDefinition typedCompartmentDefinition:
          typedCompartmentDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Composition typedComposition:
          typedComposition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ConceptMap typedConceptMap:
          typedConceptMap.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Condition typedCondition:
          typedCondition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Consent typedConsent:
          typedConsent.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Contract typedContract:
          typedContract.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Coverage typedCoverage:
          typedCoverage.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.CoverageEligibilityRequest typedCoverageEligibilityRequest:
          typedCoverageEligibilityRequest.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.CoverageEligibilityResponse typedCoverageEligibilityResponse:
          typedCoverageEligibilityResponse.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.DetectedIssue typedDetectedIssue:
          typedDetectedIssue.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Device typedDevice:
          typedDevice.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.DeviceDefinition typedDeviceDefinition:
          typedDeviceDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.DeviceMetric typedDeviceMetric:
          typedDeviceMetric.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.DeviceRequest typedDeviceRequest:
          typedDeviceRequest.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.DeviceUseStatement typedDeviceUseStatement:
          typedDeviceUseStatement.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.DiagnosticReport typedDiagnosticReport:
          typedDiagnosticReport.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.DocumentManifest typedDocumentManifest:
          typedDocumentManifest.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.DocumentReference typedDocumentReference:
          typedDocumentReference.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Encounter typedEncounter:
          typedEncounter.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Endpoint typedEndpoint:
          typedEndpoint.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.EnrollmentRequest typedEnrollmentRequest:
          typedEnrollmentRequest.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.EnrollmentResponse typedEnrollmentResponse:
          typedEnrollmentResponse.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.EpisodeOfCare typedEpisodeOfCare:
          typedEpisodeOfCare.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.EventDefinition typedEventDefinition:
          typedEventDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Evidence typedEvidence:
          typedEvidence.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.EvidenceReport typedEvidenceReport:
          typedEvidenceReport.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.EvidenceVariable typedEvidenceVariable:
          typedEvidenceVariable.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ExampleScenario typedExampleScenario:
          typedExampleScenario.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ExplanationOfBenefit typedExplanationOfBenefit:
          typedExplanationOfBenefit.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.FamilyMemberHistory typedFamilyMemberHistory:
          typedFamilyMemberHistory.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Flag typedFlag:
          typedFlag.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Goal typedGoal:
          typedGoal.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.GraphDefinition typedGraphDefinition:
          typedGraphDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Group typedGroup:
          typedGroup.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.GuidanceResponse typedGuidanceResponse:
          typedGuidanceResponse.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.HealthcareService typedHealthcareService:
          typedHealthcareService.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ImagingStudy typedImagingStudy:
          typedImagingStudy.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Immunization typedImmunization:
          typedImmunization.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ImmunizationEvaluation typedImmunizationEvaluation:
          typedImmunizationEvaluation.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ImmunizationRecommendation typedImmunizationRecommendation:
          typedImmunizationRecommendation.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ImplementationGuide typedImplementationGuide:
          typedImplementationGuide.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Ingredient typedIngredient:
          typedIngredient.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.InsurancePlan typedInsurancePlan:
          typedInsurancePlan.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Invoice typedInvoice:
          typedInvoice.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Library typedLibrary:
          typedLibrary.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Linkage typedLinkage:
          typedLinkage.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.List typedList:
          typedList.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Location typedLocation:
          typedLocation.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ManufacturedItemDefinition typedManufacturedItemDefinition:
          typedManufacturedItemDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Measure typedMeasure:
          typedMeasure.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.MeasureReport typedMeasureReport:
          typedMeasureReport.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Media typedMedia:
          typedMedia.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Medication typedMedication:
          typedMedication.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.MedicationAdministration typedMedicationAdministration:
          typedMedicationAdministration.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.MedicationDispense typedMedicationDispense:
          typedMedicationDispense.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.MedicationKnowledge typedMedicationKnowledge:
          typedMedicationKnowledge.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.MedicationRequest typedMedicationRequest:
          typedMedicationRequest.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.MedicationStatement typedMedicationStatement:
          typedMedicationStatement.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.MedicinalProductDefinition typedMedicinalProductDefinition:
          typedMedicinalProductDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.MessageDefinition typedMessageDefinition:
          typedMessageDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.MessageHeader typedMessageHeader:
          typedMessageHeader.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.MolecularSequence typedMolecularSequence:
          typedMolecularSequence.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.NamingSystem typedNamingSystem:
          typedNamingSystem.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.NutritionOrder typedNutritionOrder:
          typedNutritionOrder.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.NutritionProduct typedNutritionProduct:
          typedNutritionProduct.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Observation typedObservation:
          typedObservation.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ObservationDefinition typedObservationDefinition:
          typedObservationDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.OperationDefinition typedOperationDefinition:
          typedOperationDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.OperationOutcome typedOperationOutcome:
          typedOperationOutcome.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Organization typedOrganization:
          typedOrganization.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.OrganizationAffiliation typedOrganizationAffiliation:
          typedOrganizationAffiliation.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.PackagedProductDefinition typedPackagedProductDefinition:
          typedPackagedProductDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Parameters typedParameters:
          typedParameters.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Patient typedPatient:
          typedPatient.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.PaymentNotice typedPaymentNotice:
          typedPaymentNotice.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.PaymentReconciliation typedPaymentReconciliation:
          typedPaymentReconciliation.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Person typedPerson:
          typedPerson.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.PlanDefinition typedPlanDefinition:
          typedPlanDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Practitioner typedPractitioner:
          typedPractitioner.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.PractitionerRole typedPractitionerRole:
          typedPractitionerRole.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Procedure typedProcedure:
          typedProcedure.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Provenance typedProvenance:
          typedProvenance.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Questionnaire typedQuestionnaire:
          typedQuestionnaire.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.QuestionnaireResponse typedQuestionnaireResponse:
          typedQuestionnaireResponse.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.RegulatedAuthorization typedRegulatedAuthorization:
          typedRegulatedAuthorization.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.RelatedPerson typedRelatedPerson:
          typedRelatedPerson.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.RequestGroup typedRequestGroup:
          typedRequestGroup.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ResearchDefinition typedResearchDefinition:
          typedResearchDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ResearchElementDefinition typedResearchElementDefinition:
          typedResearchElementDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ResearchStudy typedResearchStudy:
          typedResearchStudy.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ResearchSubject typedResearchSubject:
          typedResearchSubject.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.RiskAssessment typedRiskAssessment:
          typedRiskAssessment.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Schedule typedSchedule:
          typedSchedule.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.SearchParameter typedSearchParameter:
          typedSearchParameter.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ServiceRequest typedServiceRequest:
          typedServiceRequest.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Slot typedSlot:
          typedSlot.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Specimen typedSpecimen:
          typedSpecimen.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.SpecimenDefinition typedSpecimenDefinition:
          typedSpecimenDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.StructureDefinition typedStructureDefinition:
          typedStructureDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.StructureMap typedStructureMap:
          typedStructureMap.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Subscription typedSubscription:
          typedSubscription.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.SubscriptionStatus typedSubscriptionStatus:
          typedSubscriptionStatus.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.SubscriptionTopic typedSubscriptionTopic:
          typedSubscriptionTopic.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Substance typedSubstance:
          typedSubstance.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.SubstanceDefinition typedSubstanceDefinition:
          typedSubstanceDefinition.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.SupplyDelivery typedSupplyDelivery:
          typedSupplyDelivery.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.SupplyRequest typedSupplyRequest:
          typedSupplyRequest.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.Task typedTask:
          typedTask.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.TerminologyCapabilities typedTerminologyCapabilities:
          typedTerminologyCapabilities.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.TestReport typedTestReport:
          typedTestReport.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.TestScript typedTestScript:
          typedTestScript.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.ValueSet typedValueSet:
          typedValueSet.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.VerificationResult typedVerificationResult:
          typedVerificationResult.SerializeJson(writer, options, true);
          break;
        case fhirCsR4B.Models.VisionPrescription typedVisionPrescription:
          typedVisionPrescription.SerializeJson(writer, options, true);
          break;
      }

      writer.Flush();
    }

    /// <summary>
    /// Reads and converts the JSON to a typed object.
    /// </summary>
    public override Resource Read(ref Utf8JsonReader reader, Type typeToConvert, JsonSerializerOptions options)
    {
      return PolymorphicRead(ref reader, typeToConvert, options);
    }

    /// <summary>
    /// Copy raw data from a Utf8JsonReader to a MemoryStream.
    /// </summary>
    private static void WriteReaderValueBytes(ref MemoryStream ms, ref Utf8JsonReader reader)
    {
      if (reader.HasValueSequence)
      {
        byte[] data = new byte[reader.ValueSequence.Length];
        reader.ValueSequence.CopyTo(data);
        ms.Write(data);
        return;
      }

      ms.Write(reader.ValueSpan);
    }

    /// <summary>
    /// Add a JSON seperator token, if necessary.
    /// </summary>
    private static void AddSeperatorIfNeeded(ref MemoryStream ms, ref Utf8JsonReader reader, JsonTokenType last)
    {
      switch (last)
      {
        case JsonTokenType.StartObject:
        case JsonTokenType.StartArray:
          // do nothing
          break;
        case JsonTokenType.PropertyName:
          ms.Write(_propertySep);
          break;
        default:
          ms.Write(_comma);
          break;
      }
    }

    /// <summary>
    /// Read override to handle polymorphic reading of resources.
    /// </summary>
    public static Resource PolymorphicRead(ref Utf8JsonReader reader, Type typeToConvert, JsonSerializerOptions options)
    {
      string propertyName = null;
      string resourceType = null;

      if (reader.TokenType != JsonTokenType.StartObject)
      {
        throw new JsonException();
      }

      reader.Read();
      if (reader.TokenType != JsonTokenType.PropertyName)
      {
        throw new JsonException();
      }

      propertyName = reader.GetString();
      if (propertyName == "resourceType")
      {
        reader.Read();
        if (reader.TokenType != JsonTokenType.String)
        {
          throw new JsonException();
        }

        resourceType = reader.GetString();

        return DoPolymorphicRead(ref reader, options, resourceType);
      }

      MemoryStream ms = new MemoryStream(4096);

      ms.Write(Encoding.UTF8.GetBytes($"{{\"{propertyName}\""));
      propertyName = string.Empty;

      int depth = reader.CurrentDepth;
      bool done = false;
      bool nextValueIsResourceType = false;
      JsonTokenType lastToken = JsonTokenType.PropertyName;

      while ((!done) && reader.Read())
      {
        switch (reader.TokenType)
        {
          case JsonTokenType.StartObject:
            AddSeperatorIfNeeded(ref ms, ref reader, lastToken);
            ms.Write(_startObject);
            break;

          case JsonTokenType.EndObject:
            ms.Write(_endObject);
            if (reader.CurrentDepth == (depth - 1))
            {
              done = true;
            }
            break;

          case JsonTokenType.StartArray:
            AddSeperatorIfNeeded(ref ms, ref reader, lastToken);
            ms.Write(_startArray);
            break;

          case JsonTokenType.EndArray:
            ms.Write(_endArray);
            break;

          case JsonTokenType.PropertyName:
            AddSeperatorIfNeeded(ref ms, ref reader, lastToken);
            if (reader.CurrentDepth == depth)
            {
              if (reader.ValueTextEquals("resourceType"))
              {
                nextValueIsResourceType = true;
              }
            }

            ms.Write(_quote);
            WriteReaderValueBytes(ref ms, ref reader);
            ms.Write(_quote);
            break;

          case JsonTokenType.Comment:
            break;

          case JsonTokenType.String:
            AddSeperatorIfNeeded(ref ms, ref reader, lastToken);
            if (nextValueIsResourceType)
            {
              resourceType = reader.GetString();
              nextValueIsResourceType = false;
            }

            ms.Write(_quote);
            WriteReaderValueBytes(ref ms, ref reader);
            ms.Write(_quote);
            break;

          case JsonTokenType.Number:
          case JsonTokenType.True:
          case JsonTokenType.False:
          case JsonTokenType.Null:
          default:
            AddSeperatorIfNeeded(ref ms, ref reader, lastToken);
            WriteReaderValueBytes(ref ms, ref reader);
            break;
        }

        lastToken = reader.TokenType;
      }

      ms.Flush();
      Utf8JsonReader secondary = new Utf8JsonReader(ms.GetBuffer());

      return DoPolymorphicRead(ref secondary, options, resourceType);
    }
    /// <summary>
    /// Sub-function for simpler handling of reader switching.
    /// </summary>
    public static Resource DoPolymorphicRead(ref Utf8JsonReader reader, JsonSerializerOptions options, string resourceType)
    {
      IFhirJsonSerializable target = null;
      switch (resourceType)
      {
        case "Account":
          target = new fhirCsR4B.Models.Account();
          target.DeserializeJson(ref reader, options);
          break;
        case "ActivityDefinition":
          target = new fhirCsR4B.Models.ActivityDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "AdministrableProductDefinition":
          target = new fhirCsR4B.Models.AdministrableProductDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "AdverseEvent":
          target = new fhirCsR4B.Models.AdverseEvent();
          target.DeserializeJson(ref reader, options);
          break;
        case "AllergyIntolerance":
          target = new fhirCsR4B.Models.AllergyIntolerance();
          target.DeserializeJson(ref reader, options);
          break;
        case "Appointment":
          target = new fhirCsR4B.Models.Appointment();
          target.DeserializeJson(ref reader, options);
          break;
        case "AppointmentResponse":
          target = new fhirCsR4B.Models.AppointmentResponse();
          target.DeserializeJson(ref reader, options);
          break;
        case "AuditEvent":
          target = new fhirCsR4B.Models.AuditEvent();
          target.DeserializeJson(ref reader, options);
          break;
        case "Basic":
          target = new fhirCsR4B.Models.Basic();
          target.DeserializeJson(ref reader, options);
          break;
        case "Binary":
          target = new fhirCsR4B.Models.Binary();
          target.DeserializeJson(ref reader, options);
          break;
        case "BiologicallyDerivedProduct":
          target = new fhirCsR4B.Models.BiologicallyDerivedProduct();
          target.DeserializeJson(ref reader, options);
          break;
        case "BodyStructure":
          target = new fhirCsR4B.Models.BodyStructure();
          target.DeserializeJson(ref reader, options);
          break;
        case "Bundle":
          target = new fhirCsR4B.Models.Bundle();
          target.DeserializeJson(ref reader, options);
          break;
        case "CapabilityStatement":
          target = new fhirCsR4B.Models.CapabilityStatement();
          target.DeserializeJson(ref reader, options);
          break;
        case "CarePlan":
          target = new fhirCsR4B.Models.CarePlan();
          target.DeserializeJson(ref reader, options);
          break;
        case "CareTeam":
          target = new fhirCsR4B.Models.CareTeam();
          target.DeserializeJson(ref reader, options);
          break;
        case "CatalogEntry":
          target = new fhirCsR4B.Models.CatalogEntry();
          target.DeserializeJson(ref reader, options);
          break;
        case "ChargeItem":
          target = new fhirCsR4B.Models.ChargeItem();
          target.DeserializeJson(ref reader, options);
          break;
        case "ChargeItemDefinition":
          target = new fhirCsR4B.Models.ChargeItemDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "Citation":
          target = new fhirCsR4B.Models.Citation();
          target.DeserializeJson(ref reader, options);
          break;
        case "Claim":
          target = new fhirCsR4B.Models.Claim();
          target.DeserializeJson(ref reader, options);
          break;
        case "ClaimResponse":
          target = new fhirCsR4B.Models.ClaimResponse();
          target.DeserializeJson(ref reader, options);
          break;
        case "ClinicalImpression":
          target = new fhirCsR4B.Models.ClinicalImpression();
          target.DeserializeJson(ref reader, options);
          break;
        case "ClinicalUseDefinition":
          target = new fhirCsR4B.Models.ClinicalUseDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "CodeSystem":
          target = new fhirCsR4B.Models.CodeSystem();
          target.DeserializeJson(ref reader, options);
          break;
        case "Communication":
          target = new fhirCsR4B.Models.Communication();
          target.DeserializeJson(ref reader, options);
          break;
        case "CommunicationRequest":
          target = new fhirCsR4B.Models.CommunicationRequest();
          target.DeserializeJson(ref reader, options);
          break;
        case "CompartmentDefinition":
          target = new fhirCsR4B.Models.CompartmentDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "Composition":
          target = new fhirCsR4B.Models.Composition();
          target.DeserializeJson(ref reader, options);
          break;
        case "ConceptMap":
          target = new fhirCsR4B.Models.ConceptMap();
          target.DeserializeJson(ref reader, options);
          break;
        case "Condition":
          target = new fhirCsR4B.Models.Condition();
          target.DeserializeJson(ref reader, options);
          break;
        case "Consent":
          target = new fhirCsR4B.Models.Consent();
          target.DeserializeJson(ref reader, options);
          break;
        case "Contract":
          target = new fhirCsR4B.Models.Contract();
          target.DeserializeJson(ref reader, options);
          break;
        case "Coverage":
          target = new fhirCsR4B.Models.Coverage();
          target.DeserializeJson(ref reader, options);
          break;
        case "CoverageEligibilityRequest":
          target = new fhirCsR4B.Models.CoverageEligibilityRequest();
          target.DeserializeJson(ref reader, options);
          break;
        case "CoverageEligibilityResponse":
          target = new fhirCsR4B.Models.CoverageEligibilityResponse();
          target.DeserializeJson(ref reader, options);
          break;
        case "DetectedIssue":
          target = new fhirCsR4B.Models.DetectedIssue();
          target.DeserializeJson(ref reader, options);
          break;
        case "Device":
          target = new fhirCsR4B.Models.Device();
          target.DeserializeJson(ref reader, options);
          break;
        case "DeviceDefinition":
          target = new fhirCsR4B.Models.DeviceDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "DeviceMetric":
          target = new fhirCsR4B.Models.DeviceMetric();
          target.DeserializeJson(ref reader, options);
          break;
        case "DeviceRequest":
          target = new fhirCsR4B.Models.DeviceRequest();
          target.DeserializeJson(ref reader, options);
          break;
        case "DeviceUseStatement":
          target = new fhirCsR4B.Models.DeviceUseStatement();
          target.DeserializeJson(ref reader, options);
          break;
        case "DiagnosticReport":
          target = new fhirCsR4B.Models.DiagnosticReport();
          target.DeserializeJson(ref reader, options);
          break;
        case "DocumentManifest":
          target = new fhirCsR4B.Models.DocumentManifest();
          target.DeserializeJson(ref reader, options);
          break;
        case "DocumentReference":
          target = new fhirCsR4B.Models.DocumentReference();
          target.DeserializeJson(ref reader, options);
          break;
        case "Encounter":
          target = new fhirCsR4B.Models.Encounter();
          target.DeserializeJson(ref reader, options);
          break;
        case "Endpoint":
          target = new fhirCsR4B.Models.Endpoint();
          target.DeserializeJson(ref reader, options);
          break;
        case "EnrollmentRequest":
          target = new fhirCsR4B.Models.EnrollmentRequest();
          target.DeserializeJson(ref reader, options);
          break;
        case "EnrollmentResponse":
          target = new fhirCsR4B.Models.EnrollmentResponse();
          target.DeserializeJson(ref reader, options);
          break;
        case "EpisodeOfCare":
          target = new fhirCsR4B.Models.EpisodeOfCare();
          target.DeserializeJson(ref reader, options);
          break;
        case "EventDefinition":
          target = new fhirCsR4B.Models.EventDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "Evidence":
          target = new fhirCsR4B.Models.Evidence();
          target.DeserializeJson(ref reader, options);
          break;
        case "EvidenceReport":
          target = new fhirCsR4B.Models.EvidenceReport();
          target.DeserializeJson(ref reader, options);
          break;
        case "EvidenceVariable":
          target = new fhirCsR4B.Models.EvidenceVariable();
          target.DeserializeJson(ref reader, options);
          break;
        case "ExampleScenario":
          target = new fhirCsR4B.Models.ExampleScenario();
          target.DeserializeJson(ref reader, options);
          break;
        case "ExplanationOfBenefit":
          target = new fhirCsR4B.Models.ExplanationOfBenefit();
          target.DeserializeJson(ref reader, options);
          break;
        case "FamilyMemberHistory":
          target = new fhirCsR4B.Models.FamilyMemberHistory();
          target.DeserializeJson(ref reader, options);
          break;
        case "Flag":
          target = new fhirCsR4B.Models.Flag();
          target.DeserializeJson(ref reader, options);
          break;
        case "Goal":
          target = new fhirCsR4B.Models.Goal();
          target.DeserializeJson(ref reader, options);
          break;
        case "GraphDefinition":
          target = new fhirCsR4B.Models.GraphDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "Group":
          target = new fhirCsR4B.Models.Group();
          target.DeserializeJson(ref reader, options);
          break;
        case "GuidanceResponse":
          target = new fhirCsR4B.Models.GuidanceResponse();
          target.DeserializeJson(ref reader, options);
          break;
        case "HealthcareService":
          target = new fhirCsR4B.Models.HealthcareService();
          target.DeserializeJson(ref reader, options);
          break;
        case "ImagingStudy":
          target = new fhirCsR4B.Models.ImagingStudy();
          target.DeserializeJson(ref reader, options);
          break;
        case "Immunization":
          target = new fhirCsR4B.Models.Immunization();
          target.DeserializeJson(ref reader, options);
          break;
        case "ImmunizationEvaluation":
          target = new fhirCsR4B.Models.ImmunizationEvaluation();
          target.DeserializeJson(ref reader, options);
          break;
        case "ImmunizationRecommendation":
          target = new fhirCsR4B.Models.ImmunizationRecommendation();
          target.DeserializeJson(ref reader, options);
          break;
        case "ImplementationGuide":
          target = new fhirCsR4B.Models.ImplementationGuide();
          target.DeserializeJson(ref reader, options);
          break;
        case "Ingredient":
          target = new fhirCsR4B.Models.Ingredient();
          target.DeserializeJson(ref reader, options);
          break;
        case "InsurancePlan":
          target = new fhirCsR4B.Models.InsurancePlan();
          target.DeserializeJson(ref reader, options);
          break;
        case "Invoice":
          target = new fhirCsR4B.Models.Invoice();
          target.DeserializeJson(ref reader, options);
          break;
        case "Library":
          target = new fhirCsR4B.Models.Library();
          target.DeserializeJson(ref reader, options);
          break;
        case "Linkage":
          target = new fhirCsR4B.Models.Linkage();
          target.DeserializeJson(ref reader, options);
          break;
        case "List":
          target = new fhirCsR4B.Models.List();
          target.DeserializeJson(ref reader, options);
          break;
        case "Location":
          target = new fhirCsR4B.Models.Location();
          target.DeserializeJson(ref reader, options);
          break;
        case "ManufacturedItemDefinition":
          target = new fhirCsR4B.Models.ManufacturedItemDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "Measure":
          target = new fhirCsR4B.Models.Measure();
          target.DeserializeJson(ref reader, options);
          break;
        case "MeasureReport":
          target = new fhirCsR4B.Models.MeasureReport();
          target.DeserializeJson(ref reader, options);
          break;
        case "Media":
          target = new fhirCsR4B.Models.Media();
          target.DeserializeJson(ref reader, options);
          break;
        case "Medication":
          target = new fhirCsR4B.Models.Medication();
          target.DeserializeJson(ref reader, options);
          break;
        case "MedicationAdministration":
          target = new fhirCsR4B.Models.MedicationAdministration();
          target.DeserializeJson(ref reader, options);
          break;
        case "MedicationDispense":
          target = new fhirCsR4B.Models.MedicationDispense();
          target.DeserializeJson(ref reader, options);
          break;
        case "MedicationKnowledge":
          target = new fhirCsR4B.Models.MedicationKnowledge();
          target.DeserializeJson(ref reader, options);
          break;
        case "MedicationRequest":
          target = new fhirCsR4B.Models.MedicationRequest();
          target.DeserializeJson(ref reader, options);
          break;
        case "MedicationStatement":
          target = new fhirCsR4B.Models.MedicationStatement();
          target.DeserializeJson(ref reader, options);
          break;
        case "MedicinalProductDefinition":
          target = new fhirCsR4B.Models.MedicinalProductDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "MessageDefinition":
          target = new fhirCsR4B.Models.MessageDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "MessageHeader":
          target = new fhirCsR4B.Models.MessageHeader();
          target.DeserializeJson(ref reader, options);
          break;
        case "MolecularSequence":
          target = new fhirCsR4B.Models.MolecularSequence();
          target.DeserializeJson(ref reader, options);
          break;
        case "NamingSystem":
          target = new fhirCsR4B.Models.NamingSystem();
          target.DeserializeJson(ref reader, options);
          break;
        case "NutritionOrder":
          target = new fhirCsR4B.Models.NutritionOrder();
          target.DeserializeJson(ref reader, options);
          break;
        case "NutritionProduct":
          target = new fhirCsR4B.Models.NutritionProduct();
          target.DeserializeJson(ref reader, options);
          break;
        case "Observation":
          target = new fhirCsR4B.Models.Observation();
          target.DeserializeJson(ref reader, options);
          break;
        case "ObservationDefinition":
          target = new fhirCsR4B.Models.ObservationDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "OperationDefinition":
          target = new fhirCsR4B.Models.OperationDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "OperationOutcome":
          target = new fhirCsR4B.Models.OperationOutcome();
          target.DeserializeJson(ref reader, options);
          break;
        case "Organization":
          target = new fhirCsR4B.Models.Organization();
          target.DeserializeJson(ref reader, options);
          break;
        case "OrganizationAffiliation":
          target = new fhirCsR4B.Models.OrganizationAffiliation();
          target.DeserializeJson(ref reader, options);
          break;
        case "PackagedProductDefinition":
          target = new fhirCsR4B.Models.PackagedProductDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "Parameters":
          target = new fhirCsR4B.Models.Parameters();
          target.DeserializeJson(ref reader, options);
          break;
        case "Patient":
          target = new fhirCsR4B.Models.Patient();
          target.DeserializeJson(ref reader, options);
          break;
        case "PaymentNotice":
          target = new fhirCsR4B.Models.PaymentNotice();
          target.DeserializeJson(ref reader, options);
          break;
        case "PaymentReconciliation":
          target = new fhirCsR4B.Models.PaymentReconciliation();
          target.DeserializeJson(ref reader, options);
          break;
        case "Person":
          target = new fhirCsR4B.Models.Person();
          target.DeserializeJson(ref reader, options);
          break;
        case "PlanDefinition":
          target = new fhirCsR4B.Models.PlanDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "Practitioner":
          target = new fhirCsR4B.Models.Practitioner();
          target.DeserializeJson(ref reader, options);
          break;
        case "PractitionerRole":
          target = new fhirCsR4B.Models.PractitionerRole();
          target.DeserializeJson(ref reader, options);
          break;
        case "Procedure":
          target = new fhirCsR4B.Models.Procedure();
          target.DeserializeJson(ref reader, options);
          break;
        case "Provenance":
          target = new fhirCsR4B.Models.Provenance();
          target.DeserializeJson(ref reader, options);
          break;
        case "Questionnaire":
          target = new fhirCsR4B.Models.Questionnaire();
          target.DeserializeJson(ref reader, options);
          break;
        case "QuestionnaireResponse":
          target = new fhirCsR4B.Models.QuestionnaireResponse();
          target.DeserializeJson(ref reader, options);
          break;
        case "RegulatedAuthorization":
          target = new fhirCsR4B.Models.RegulatedAuthorization();
          target.DeserializeJson(ref reader, options);
          break;
        case "RelatedPerson":
          target = new fhirCsR4B.Models.RelatedPerson();
          target.DeserializeJson(ref reader, options);
          break;
        case "RequestGroup":
          target = new fhirCsR4B.Models.RequestGroup();
          target.DeserializeJson(ref reader, options);
          break;
        case "ResearchDefinition":
          target = new fhirCsR4B.Models.ResearchDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "ResearchElementDefinition":
          target = new fhirCsR4B.Models.ResearchElementDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "ResearchStudy":
          target = new fhirCsR4B.Models.ResearchStudy();
          target.DeserializeJson(ref reader, options);
          break;
        case "ResearchSubject":
          target = new fhirCsR4B.Models.ResearchSubject();
          target.DeserializeJson(ref reader, options);
          break;
        case "RiskAssessment":
          target = new fhirCsR4B.Models.RiskAssessment();
          target.DeserializeJson(ref reader, options);
          break;
        case "Schedule":
          target = new fhirCsR4B.Models.Schedule();
          target.DeserializeJson(ref reader, options);
          break;
        case "SearchParameter":
          target = new fhirCsR4B.Models.SearchParameter();
          target.DeserializeJson(ref reader, options);
          break;
        case "ServiceRequest":
          target = new fhirCsR4B.Models.ServiceRequest();
          target.DeserializeJson(ref reader, options);
          break;
        case "Slot":
          target = new fhirCsR4B.Models.Slot();
          target.DeserializeJson(ref reader, options);
          break;
        case "Specimen":
          target = new fhirCsR4B.Models.Specimen();
          target.DeserializeJson(ref reader, options);
          break;
        case "SpecimenDefinition":
          target = new fhirCsR4B.Models.SpecimenDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "StructureDefinition":
          target = new fhirCsR4B.Models.StructureDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "StructureMap":
          target = new fhirCsR4B.Models.StructureMap();
          target.DeserializeJson(ref reader, options);
          break;
        case "Subscription":
          target = new fhirCsR4B.Models.Subscription();
          target.DeserializeJson(ref reader, options);
          break;
        case "SubscriptionStatus":
          target = new fhirCsR4B.Models.SubscriptionStatus();
          target.DeserializeJson(ref reader, options);
          break;
        case "SubscriptionTopic":
          target = new fhirCsR4B.Models.SubscriptionTopic();
          target.DeserializeJson(ref reader, options);
          break;
        case "Substance":
          target = new fhirCsR4B.Models.Substance();
          target.DeserializeJson(ref reader, options);
          break;
        case "SubstanceDefinition":
          target = new fhirCsR4B.Models.SubstanceDefinition();
          target.DeserializeJson(ref reader, options);
          break;
        case "SupplyDelivery":
          target = new fhirCsR4B.Models.SupplyDelivery();
          target.DeserializeJson(ref reader, options);
          break;
        case "SupplyRequest":
          target = new fhirCsR4B.Models.SupplyRequest();
          target.DeserializeJson(ref reader, options);
          break;
        case "Task":
          target = new fhirCsR4B.Models.Task();
          target.DeserializeJson(ref reader, options);
          break;
        case "TerminologyCapabilities":
          target = new fhirCsR4B.Models.TerminologyCapabilities();
          target.DeserializeJson(ref reader, options);
          break;
        case "TestReport":
          target = new fhirCsR4B.Models.TestReport();
          target.DeserializeJson(ref reader, options);
          break;
        case "TestScript":
          target = new fhirCsR4B.Models.TestScript();
          target.DeserializeJson(ref reader, options);
          break;
        case "ValueSet":
          target = new fhirCsR4B.Models.ValueSet();
          target.DeserializeJson(ref reader, options);
          break;
        case "VerificationResult":
          target = new fhirCsR4B.Models.VerificationResult();
          target.DeserializeJson(ref reader, options);
          break;
        case "VisionPrescription":
          target = new fhirCsR4B.Models.VisionPrescription();
          target.DeserializeJson(ref reader, options);
          break;
        default:
          target = new fhirCsR4B.Models.Resource();
          target.DeserializeJson(ref reader, options);
          break;
      }

      return (Resource)target;
    }
  }
}
